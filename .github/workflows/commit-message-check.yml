name: Commit Message Check

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  commit-message-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate commit messages and PR title
        run: |
          set -e

          VALID_PREFIX_REGEX="^(feat|perf|fix|docs|style|refactor|build|ci|chore|release):"

          # ✅ PUSH → validate commit message
          if [ "${{ github.event_name }}" = "push" ]; then
            COMMIT_MSG=$(git log -1 --pretty=%s)
            echo "Checking commit message: $COMMIT_MSG"

            if ! echo "$COMMIT_MSG" | grep -Eq "$VALID_PREFIX_REGEX"; then
              echo "❌ INVALID COMMIT MESSAGE"
              exit 1
            fi
          fi

          # ✅ PR → validate PR title ONLY
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            PR_TITLE="${{ github.event.pull_request.title }}"
            echo "Checking PR title: $PR_TITLE"

            if ! echo "$PR_TITLE" | grep -Eq "$VALID_PREFIX_REGEX"; then
              echo "❌ INVALID PR TITLE"
              exit 1
            fi
          fi

          echo "✅ Validation passed"
