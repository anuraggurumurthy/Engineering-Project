name: Update Release Notes

on:
  push:
    branches:
      - master

jobs:
  release-notes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read commit message
        id: commit
        run: |
          echo "msg=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT

      - name: Extract version
        id: version
        run: |
          if [[ "${{ steps.commit.outputs.msg }}" =~ release:\ ([0-9]+\.[0-9]+\.[0-9]+) ]]; then
            echo "ver=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
          else
            echo "ver=$(cat release-notes/.current_release 2>/dev/null || echo 0.0.0)" >> $GITHUB_OUTPUT
          fi

      - name: Set IST time
        id: time
        run: |
          echo "now=$(TZ=Asia/Kolkata date '+%a %b %d %H:%M:%S IST %Y')" >> $GITHUB_OUTPUT

      - name: Update release notes
        run: |
          VERSION=${{ steps.version.outputs.ver }}
          FILE="release-notes/RELEASE_v${VERSION}.txt"
          MSG="${{ steps.commit.outputs.msg }}"
          DATE="${{ steps.time.outputs.now }}"

          mkdir -p release-notes

          if [[ ! -f "$FILE" ]]; then
            cat <<EOF > "$FILE"
Release v$VERSION
Date: $DATE

Features:

Fixes:
EOF
          fi

          if [[ "$MSG" == feat:* ]]; then
            sed -i "/^Features:/a\\- ${MSG}" "$FILE"
          fi

          if [[ "$MSG" == fix:* ]]; then
            sed -i "/^Fixes:/a\\- ${MSG}" "$FILE"
          fi

          echo "$VERSION" > release-notes/.current_release

      - name: Normalize spacing
        run: |
          FILE="release-notes/RELEASE_v${{ steps.version.outputs.ver }}.txt"
          awk '
          /^Release / { print; next }
          /^Date:/ { print; print ""; next }
          /^Features:/ { print; next }
          /^Fixes:/ { print ""; print; next }
          { print }
          ' "$FILE" > tmp && mv tmp "$FILE"

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add release-notes
          git commit -m "docs: update release notes v${{ steps.version.outputs.ver }}" || echo "No changes"
          git push
