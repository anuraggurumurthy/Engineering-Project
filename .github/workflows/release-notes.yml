name: Update Release Notes

on:
  push:
    branches:
      - master

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Read last commit message
        id: commit
        run: |
          echo "msg=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT

      - name: Resolve release version
        id: version
        run: |
          if [[ "${{ steps.commit.outputs.msg }}" =~ ^release:\ ([0-9]+\.[0-9]+\.[0-9]+) ]]; then
            echo "ver=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
          else
            echo "ver=$(cat release-notes/.current_release 2>/dev/null || echo '')" >> $GITHUB_OUTPUT
          fi

      - name: Stop if no active release
        if: steps.version.outputs.ver == ''
        run: |
          echo "No active release version. Skipping."
          exit 0

      - name: IST time
        id: time
        run: |
          echo "now=$(TZ=Asia/Kolkata date '+%a %b %d %H:%M:%S IST %Y')" >> $GITHUB_OUTPUT

      - name: Update release file
        run: |
          VERSION=${{ steps.version.outputs.ver }}
          FILE="release-notes/RELEASE_v${VERSION}.txt"
          MSG="${{ steps.commit.outputs.msg }}"
          DATE="${{ steps.time.outputs.now }}"

          mkdir -p release-notes

          # Create file if missing
          if [[ ! -f "$FILE" ]]; then
            cat <<EOF > "$FILE"
Release v$VERSION
Date: $DATE

Features:

Fixes:
EOF
          fi

          # Append entries
          if [[ "$MSG" == feat:* ]]; then
            sed -i "/^Features:/a\\- ${MSG#feat: }" "$FILE"
          fi

          if [[ "$MSG" == fix:* ]]; then
            sed -i "/^Fixes:/a\\- ${MSG#fix: }" "$FILE"
          fi

          echo "$VERSION" > release-notes/.current_release

      - name: Normalize spacing (ONE blank line only)
        run: |
          FILE="release-notes/RELEASE_v${{ steps.version.outputs.ver }}.txt"
          awk '
          /^Release / {print; next}
          /^Date:/ {print; print ""; next}
          /^Features:/ {print; next}
          /^Fixes:/ {print ""; print; next}
          NF {print}
          ' "$FILE" > tmp && mv tmp "$FILE"

      - name: Commit changes
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add release-notes
          git commit -m "docs: update release notes v${{ steps.version.outputs.ver }}" || exit 0
          git push
