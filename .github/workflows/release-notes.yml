name: Auto Release Notes

on:
  push:
    branches:
      - master

permissions:
  contents: write

jobs:
  release-notes:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate / Update release notes
        run: |
          set -e

          AUTHOR=$(git log -1 --pretty=%an)
          COMMIT_MSG=$(git log -1 --pretty=%s)
          DATE=$(TZ="Asia/Kolkata" date +"%a %b %d %H:%M:%S IST %Y")

          # âŒ Ignore bot commits
          if [[ "$AUTHOR" == "github-actions" ]]; then
            echo "Skipping bot commit"
            exit 0
          fi

          mkdir -p release-notes

          # -----------------------
          # RELEASE commit
          # -----------------------
          if [[ "$COMMIT_MSG" =~ ^release:\ ?v ]]; then
            VERSION=$(echo "$COMMIT_MSG" | sed 's/release: //')

            echo "$VERSION" > release-notes/.current_release
            FILE="release-notes/RELEASE_${VERSION}.txt"

            if [ ! -f "$FILE" ]; then
              {
                echo "Release $VERSION"
                echo "Date: $DATE"
                echo
                echo "Features:"
                echo
                echo "Fixes:"
              } > "$FILE"
            fi

            git config user.name "github-actions"
            git config user.email "github-actions@github.com"

            git add release-notes
            git commit -m "docs: start release notes $VERSION"
            git push
            exit 0
          fi

          # -----------------------
          # FEAT / FIX commits
          # -----------------------
          if [ ! -f release-notes/.current_release ]; then
            echo "No active release"
            exit 0
          fi

          VERSION=$(cat release-notes/.current_release)
          FILE="release-notes/RELEASE_${VERSION}.txt"

          if [[ "$COMMIT_MSG" =~ ^feat: ]]; then
            sed -i "/^Features:/a\\- ${COMMIT_MSG#feat: }" "$FILE"
          elif [[ "$COMMIT_MSG" =~ ^fix: ]]; then
            sed -i "/^Fixes:/a\\- ${COMMIT_MSG#fix: }" "$FILE"
          else
            echo "Not feat/fix"
            exit 0
          fi

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add "$FILE"
          git commit -m "docs: update release notes $VERSION"
          git push
