name: Update Release Notes

on:
  push:
    branches:
      - master

jobs:
  update-release-notes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Read commit message
        id: commit
        run: |
          echo "msg=$(git log -1 --pretty=%B | tr -d '\n')" >> $GITHUB_OUTPUT

      - name: Update release notes file
        run: |
          COMMIT_MSG="${{ steps.commit.outputs.msg }}"
          FILE="release-notes/RELEASE_v1.0.89.txt"

          if [[ ! -f "$FILE" ]]; then
            echo "Release file not found"
            exit 1
          fi

          # ---------- FEATURE ----------
          if [[ "$COMMIT_MSG" =~ ^feat: ]]; then
            ITEM="- ${COMMIT_MSG#feat: }"

            awk -v item="$ITEM" '
            BEGIN { added=0 }
            {
              print
              if ($0 == "Features:" && !added) {
                getline
                if ($0 != "") print
                print item
                added=1
              }
            }
            ' "$FILE" > tmp && mv tmp "$FILE"
          fi

          # ---------- FIX ----------
          if [[ "$COMMIT_MSG" =~ ^fix: ]]; then
            ITEM="- ${COMMIT_MSG#fix: }"

            awk -v item="$ITEM" '
            BEGIN { added=0 }
            {
              print
              if ($0 == "Fixes:" && !added) {
                getline
                if ($0 != "") print
                print item
                added=1
              }
            }
            ' "$FILE" > tmp && mv tmp "$FILE"
          fi

      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add release-notes/
          git diff --cached --quiet && exit 0

          git commit -m "docs: update release notes v1.0.89"
          git push
