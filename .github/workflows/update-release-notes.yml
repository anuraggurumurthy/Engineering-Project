name: Update Release Notes

on:
  push:
    branches:
      - master

jobs:
  update-release-notes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Get commit message
        id: commit
        run: |
          echo "msg=$(git log -1 --pretty=%B | tr -d '\n')" >> $GITHUB_OUTPUT

      - name: Get current release file
        id: release
        run: |
          VERSION=$(ls release-notes/RELEASE_v*.txt | sort -V | tail -n 1)
          echo "file=$VERSION" >> $GITHUB_OUTPUT

      - name: Update release notes
        run: |
          COMMIT_MSG="${{ steps.commit.outputs.msg }}"
          FILE="${{ steps.release.outputs.file }}"

          if [[ ! -f "$FILE" ]]; then
            echo "Release file not found"
            exit 1
          fi

          # ---------- FEAT ----------
          if [[ "$COMMIT_MSG" =~ ^feat: ]]; then
            ENTRY="- ${COMMIT_MSG#feat: }"

            awk -v entry="$ENTRY" '
            BEGIN { done=0 }
            /^Features:/ {
              print
              print ""           # <<< FORCE BLANK LINE
              while (getline && $0 ~ /^-/) print
              if (!done) {
                print entry
                done=1
              }
              print ""
              next
            }
            { print }
            ' "$FILE" > tmp && mv tmp "$FILE"

          # ---------- FIX ----------
          elif [[ "$COMMIT_MSG" =~ ^fix: ]]; then
            ENTRY="- ${COMMIT_MSG#fix: }"

            awk -v entry="$ENTRY" '
            BEGIN { done=0 }
            /^Fixes:/ {
              print
              print ""           # <<< FORCE BLANK LINE
              while (getline && $0 ~ /^-/) print
              if (!done) {
                print entry
                done=1
              }
              print ""
              next
            }
            { print }
            ' "$FILE" > tmp && mv tmp "$FILE"

          else
            echo "No feat/fix commit. Skipping."
            exit 0
          fi

      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add release-notes/
          git diff --cached --quiet && exit 0

          git commit -m "docs: update release notes"
          git push
