name: Update Release Notes

on:
  push:
    branches:
      - master

jobs:
  update-release-notes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Get commit message
        id: commit
        run: |
          echo "msg=$(git log -1 --pretty=%B | tr -d '\n')" >> $GITHUB_OUTPUT

      - name: Update release notes
        run: |
          COMMIT_MSG="${{ steps.commit.outputs.msg }}"
          FILE="release-notes/RELEASE_v1.0.89.txt"

          if [[ ! -f "$FILE" ]]; then
            echo "Release file not found"
            exit 1
          fi

          if [[ "$COMMIT_MSG" =~ ^feat: ]]; then
            TEXT="- ${COMMIT_MSG#feat: }"

            awk -v text="$TEXT" '
            BEGIN { in_section=0 }
            /^Features:/ { print; in_section=1; next }
            /^Fixes:/ { in_section=0; print }
            in_section && NF==0 { print text; in_section=0 }
            { print }
            ' "$FILE" > tmp && mv tmp "$FILE"

          elif [[ "$COMMIT_MSG" =~ ^fix: ]]; then
            TEXT="- ${COMMIT_MSG#fix: }"

            awk -v text="$TEXT" '
            BEGIN { in_section=0 }
            /^Fixes:/ { print; in_section=1; next }
            in_section && NF==0 { print text; in_section=0 }
            { print }
            ' "$FILE" > tmp && mv tmp "$FILE"

          else
            echo "No feat/fix commit. Skipping."
            exit 0
          fi

      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add release-notes/
          git diff --cached --quiet && exit 0

          git commit -m "docs: update release notes v1.0.89"
          git push
