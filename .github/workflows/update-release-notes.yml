name: Update Release Notes

on:
  push:
    branches:
      - master

jobs:
  update-release-notes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Get last commit message
        id: commit
        run: |
          echo "msg=$(git log -1 --pretty=%B | tr -d '\r\n')" >> $GITHUB_OUTPUT

      - name: Resolve release file
        id: release
        run: |
          MSG="${{ steps.commit.outputs.msg }}"

          if [[ "$MSG" =~ ^release:\ ([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            VERSION="${BASH_REMATCH[1]}"
          else
            VERSION=$(ls release-notes | sort -V | tail -1 | sed 's/RELEASE_v//;s/.txt//')
          fi

          FILE="release-notes/RELEASE_v${VERSION}.txt"

          if [[ ! -f "$FILE" ]]; then
            echo "❌ Release file not found: $FILE"
            exit 1
          fi

          echo "file=$FILE" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Update release notes
        run: |
          MSG="${{ steps.commit.outputs.msg }}"
          FILE="${{ steps.release.outputs.file }}"

          if [[ "$MSG" =~ ^feat:\ (.+)$ ]]; then
            TEXT="- ${BASH_REMATCH[1]}"
            SECTION="Features"

          elif [[ "$MSG" =~ ^fix:\ (.+)$ ]]; then
            TEXT="- ${BASH_REMATCH[1]}"
            SECTION="Fixes"

          else
            echo "ℹ️ Not a feat/fix commit. Skipping."
            exit 0
          fi

          awk -v section="$SECTION" -v text="$TEXT" '
          BEGIN { added=0 }
          {
            print
            if ($0 == section ":") {
              getline
              if ($0 != "") print ""
              print text
              print ""
              added=1
            }
          }
          END {
            if (!added) {
              print ""
              print section ":"
              print text
              print ""
            }
          }
          ' "$FILE" > tmp && mv tmp "$FILE"

      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add release-notes/
          git diff --cached --quiet && exit 0

          git commit -m "docs: update release notes ${{ steps.release.outputs.version }}"
          git push
