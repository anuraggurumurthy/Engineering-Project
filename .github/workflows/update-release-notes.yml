name: Update Release Notes

on:
  push:
    branches:
      - master

jobs:
  update-release-notes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Get commit message
        id: commit
        run: |
          echo "msg=$(git log -1 --pretty=%B | tr -d '\n')" >> $GITHUB_OUTPUT

      - name: Update release notes
        run: |
          COMMIT_MSG="${{ steps.commit.outputs.msg }}"
          FILE="release-notes/RELEASE_v1.0.89.txt"

          # Ignore release commits cleanly
          if [[ "$COMMIT_MSG" =~ ^release: ]]; then
            echo "Release commit detected. Skipping update."
            exit 0
          fi

          if [[ "$COMMIT_MSG" =~ ^feat: ]]; then
            ITEM="- ${COMMIT_MSG#feat: }"
            SECTION="Features"

          elif [[ "$COMMIT_MSG" =~ ^fix: ]]; then
            ITEM="- ${COMMIT_MSG#fix: }"
            SECTION="Fixes"

          else
            echo "Not a feat/fix commit. Skipping."
            exit 0
          fi

          awk -v section="$SECTION" -v item="$ITEM" '
          BEGIN { inserted=0 }
          {
            print
            if ($0 == section ":") {
              getline
              while ($0 == "") getline
              print ""
              print item
              print ""
              print
              inserted=1
            }
          }
          END {
            if (!inserted) {
              print ""
              print section ":"
              print ""
              print item
            }
          }
          ' "$FILE" > tmp && mv tmp "$FILE"

      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add release-notes/
          git diff --cached --quiet && exit 0

          git commit -m "docs: update release notes"
          git push
