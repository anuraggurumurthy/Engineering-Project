name: Update Release Notes

on:
  push:
    branches:
      - master

jobs:
  release-notes:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Read commit message
        id: commit
        run: |
          echo "msg=$(git log -1 --pretty=%B | tr -d '\r')" >> $GITHUB_OUTPUT

      - name: Process release notes
        run: |
          COMMIT="${{ steps.commit.outputs.msg }}"
          RELEASE_DIR="release-notes"
          CURRENT_FILE="$RELEASE_DIR/.current_release"

          mkdir -p "$RELEASE_DIR"

          # -------------------------
          # RELEASE COMMIT
          # -------------------------
          if [[ "$COMMIT" =~ ^release: ]]; then
            VERSION="${COMMIT#release: }"
            DATE=$(TZ=Asia/Kolkata date)

            echo "$VERSION" > "$CURRENT_FILE"

            FILE="$RELEASE_DIR/RELEASE_$VERSION.txt"

            cat > "$FILE" <<EOF
Release $VERSION
Date: $DATE

Features:

Fixes:
EOF
            exit 0
          fi

          # -------------------------
          # FEAT / FIX COMMITS
          # -------------------------
          [[ ! -f "$CURRENT_FILE" ]] && exit 0

          VERSION=$(cat "$CURRENT_FILE")
          FILE="$RELEASE_DIR/RELEASE_$VERSION.txt"

          [[ ! -f "$FILE" ]] && exit 0

          if [[ "$COMMIT" =~ ^feat: ]]; then
            ITEM="- ${COMMIT#feat: }"

            awk -v item="$ITEM" '
              /^Features:/ {
                print
                getline; print
                print item
                next
              }
              { print }
            ' "$FILE" > tmp && mv tmp "$FILE"

          elif [[ "$COMMIT" =~ ^fix: ]]; then
            ITEM="- ${COMMIT#fix: }"

            awk -v item="$ITEM" '
              /^Fixes:/ {
                print
                getline; print
                print item
                next
              }
              { print }
            ' "$FILE" > tmp && mv tmp "$FILE"
          fi

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add release-notes
          git diff --cached --quiet && exit 0

          git commit -m "docs: update release notes"
          git push
