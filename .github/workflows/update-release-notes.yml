name: Auto Release Notes (TXT)

on:
  push:
    branches:
      - master
      - main

permissions:
  contents: write

jobs:
  release-notes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure Git
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

      - name: Update release notes
        run: |
          COMMIT_MSG="$(git log -1 --pretty=%B | tr -d '\r')"
          echo "Commit: $COMMIT_MSG"

          mkdir -p release-notes

          # -------- RELEASE --------
          if [[ "$COMMIT_MSG" == release:* ]]; then
            VERSION="${COMMIT_MSG#release: }"

            echo "$VERSION" > release-notes/CURRENT_VERSION.txt

            FILE="release-notes/$VERSION.txt"

            cat <<EOF > "$FILE"
Release: $VERSION

Features:

Fixes:
EOF

            git add release-notes
            git commit -m "chore: release $VERSION"
            git push

          # -------- FEAT / FIX --------
          elif [[ "$COMMIT_MSG" == feat:* || "$COMMIT_MSG" == fix:* ]]; then
            VERSION=$(cat release-notes/CURRENT_VERSION.txt)

            TYPE="${COMMIT_MSG%%:*}"
            MESSAGE="${COMMIT_MSG#*: }"

            FILE="release-notes/$VERSION.txt"

            if [[ "$TYPE" == "feat" ]]; then
              sed -i "/^Features:/a - $MESSAGE" "$FILE"
            else
              sed -i "/^Fixes:/a - $MESSAGE" "$FILE"
            fi

            git add "$FILE"
            git commit -m "docs: update release notes"
            git push
          fi

      - name: Create GitHub Release
        if: startsWith(github.event.head_commit.message, 'release:')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.head_commit.message }}
          name: Release ${{ github.event.head_commit.message }}
          body_path: release-notes/${{ github.event.head_commit.message }}.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
