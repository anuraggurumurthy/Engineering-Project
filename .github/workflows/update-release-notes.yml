name: Auto Release Notes

on:
  push:
    branches:
      - master

jobs:
  generate-release-notes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo (FULL HISTORY)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate release notes
        run: |
          set -e

          # Get latest release commit
          RELEASE_COMMIT=$(git log --grep="^release:" --format="%H" -n 1)

          if [ -z "$RELEASE_COMMIT" ]; then
            echo "No release commit found"
            exit 0
          fi

          VERSION=$(git log -1 --pretty=%B "$RELEASE_COMMIT" | sed 's/release:[[:space:]]*//')

          # Get previous release commit
          PREV_RELEASE=$(git log --grep="^release:" --format="%H" -n 2 | tail -n 1)

          if [ -z "$PREV_RELEASE" ]; then
            RANGE="$RELEASE_COMMIT"
          else
            RANGE="$PREV_RELEASE..$RELEASE_COMMIT"
          fi

          echo "Commit range: $RANGE"

          FEATURES=$(git log $RANGE --no-merges --pretty=%s | grep "^feat:" || true)
          FIXES=$(git log $RANGE --no-merges --pretty=%s | grep "^fix:" || true)

          mkdir -p release-notes
          FILE="release-notes/RELEASE_v${VERSION}.txt"

          {
            echo "Release v${VERSION}"
            echo "Date: $(TZ=Asia/Kolkata date)"
            echo
            echo "Features:"
            if [ -n "$FEATURES" ]; then
              echo "$FEATURES" | sed 's/^/- /'
            else
              echo "- None"
            fi
            echo
            echo "Fixes:"
            if [ -n "$FIXES" ]; then
              echo "$FIXES" | sed 's/^/- /'
            else
              echo "- None"
            fi
          } > "$FILE"

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add "$FILE"
          git commit -m "docs: release notes v${VERSION}"
          git push
