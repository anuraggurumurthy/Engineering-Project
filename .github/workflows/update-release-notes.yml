name: Auto Release Notes (TXT)

on:
  push:
    branches:
      - master
      - main

permissions:
  contents: write

jobs:
  update-files:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract.outputs.version }}

    steps:
      - uses: actions/checkout@v4

      - name: Configure Git
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

      - name: Extract commit info
        id: extract
        run: |
          MSG="$(git log -1 --pretty=%B | tr -d '\r')"
          echo "msg=$MSG" >> $GITHUB_OUTPUT

          if [[ "$MSG" == release:* ]]; then
            VERSION="${MSG#release: }"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Update release notes
        run: |
          MSG="${{ steps.extract.outputs.msg }}"
          VERSION="${{ steps.extract.outputs.version }}"

          mkdir -p release-notes

          if [[ "$MSG" == release:* ]]; then
            echo "$VERSION" > release-notes/CURRENT_VERSION.txt

            cat <<EOF > release-notes/$VERSION.txt
Release: $VERSION

Features:

Fixes:
EOF

            git add release-notes
            git commit -m "chore: prepare release $VERSION"
            git push

          elif [[ "$MSG" == feat:* || "$MSG" == fix:* ]]; then
            VERSION=$(cat release-notes/CURRENT_VERSION.txt)
            FILE="release-notes/$VERSION.txt"
            TEXT="${MSG#*: }"

            if [[ "$MSG" == feat:* ]]; then
              sed -i "/^Features:/a - $TEXT" "$FILE"
            else
              sed -i "/^Fixes:/a - $TEXT" "$FILE"
            fi

            git add "$FILE"
            git commit -m "docs: update release notes"
            git push
          fi

  create-release:
    needs: update-files
    if: needs.update-files.outputs.version != ''
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.update-files.outputs.version }}"

          gh release create "$VERSION" \
            --title "Release $VERSION" \
            --notes-file "release-notes/$VERSION.txt"
