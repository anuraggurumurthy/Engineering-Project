name: Auto Update Release Notes

on:
  push:
    branches:
      - master

permissions:
  contents: write

jobs:
  release-notes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure Git
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

      - name: Update Release Notes
        run: |
          COMMIT_MSG="$(git log -1 --pretty=%B)"
          echo "Commit: $COMMIT_MSG"

          mkdir -p release-notes

          # ---------------- RELEASE ----------------
          if [[ "$COMMIT_MSG" == release:* ]]; then
            VERSION=$(echo "$COMMIT_MSG" | sed 's/release:[[:space:]]*//')

            echo "$VERSION" > release-notes/CURRENT_VERSION.txt

            FILE="release-notes/$VERSION.txt"

            cat <<EOF > "$FILE"
          Release: $VERSION

          Features:

          Fixes:
          EOF

            git add release-notes
            git commit -m "chore: create release $VERSION"
            git push

          # ---------------- FEAT / FIX ----------------
          elif [[ "$COMMIT_MSG" == feat:* || "$COMMIT_MSG" == fix:* ]]; then
            TYPE=$(echo "$COMMIT_MSG" | cut -d: -f1)
            MESSAGE=$(echo "$COMMIT_MSG" | sed 's/^[a-z]*:[[:space:]]*//')

            VERSION=$(cat release-notes/CURRENT_VERSION.txt)
            FILE="release-notes/$VERSION.txt"

            if [[ "$TYPE" == "feat" ]]; then
              sed -i "/Features:/a - $MESSAGE" "$FILE"
            else
              sed -i "/Fixes:/a - $MESSAGE" "$FILE"
            fi

            git add "$FILE"
            git commit -m "docs: update release notes"
            git push
          fi
