name: Update Release Notes

on:
  push:
    branches:
      - master

jobs:
  release-notes:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Get last commit message
        id: commit
        run: |
          echo "msg=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT

      - name: Update release notes
        run: |
          COMMIT_MSG="${{ steps.commit.outputs.msg }}"
          FILE="release-notes/RELEASE_v1.0.89.txt"

          # Ignore merge & release commits
          [[ "$COMMIT_MSG" =~ ^Merge ]] && exit 0
          [[ "$COMMIT_MSG" =~ ^release: ]] && exit 0

          if [[ "$COMMIT_MSG" =~ ^feat: ]]; then
            SECTION="Features"
            ITEM="- ${COMMIT_MSG#feat: }"
          elif [[ "$COMMIT_MSG" =~ ^fix: ]]; then
            SECTION="Fixes"
            ITEM="- ${COMMIT_MSG#fix: }"
          else
            exit 0
          fi

          awk -v section="$SECTION" -v item="$ITEM" '
          {
            print
            if ($0 == section ":") {
              getline
              print item
            }
          }
          END {
            if (!found) {
              print ""
              print section ":"
              print item
            }
          }
          ' "$FILE" > tmp && mv tmp "$FILE"

      - name: Commit & push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add release-notes/
          git diff --cached --quiet && exit 0

          git commit -m "docs: update release notes"
          git push
