name: Auto Release Notes

on:
  push:
    branches:
      - master

jobs:
  update-release-notes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update release notes
        run: |
          set -e

          COMMIT_SUBJECT=$(git log -1 --pretty=%s)

          # Find latest release version
          LAST_RELEASE=$(git log --grep="^release:" --format="%s" -n 1 | sed 's/release:[[:space:]]*//')

          if [ -z "$LAST_RELEASE" ]; then
            echo "No release found. Skipping."
            exit 0
          fi

          mkdir -p release-notes
          FILE="release-notes/RELEASE_v${LAST_RELEASE}.txt"

          # Create release file if it doesn't exist
          if [ ! -f "$FILE" ]; then
            {
              echo "release v${LAST_RELEASE}"
              echo "date: $(TZ=Asia/Kolkata date)"
              echo
              echo "features:"
              echo "fixes:"
              echo "docs:"
              echo "style:"
              echo "refactor:"
              echo "build:"
              echo "ci:"
              echo "chore:"
            } > "$FILE"
          fi

          # Ignore release commit itself
          if echo "$COMMIT_SUBJECT" | grep -q "^release:"; then
            echo "Release commit detected. File created only."
            exit 0
          fi

          add_entry() {
            local section="$1"
            local text="$2"
            sed -i "/^${section}:/a\\- ${text}" "$FILE"
          }

          case "$COMMIT_SUBJECT" in
            feat:*)      add_entry "features" "${COMMIT_SUBJECT#feat: }" ;;
            perf:*)      add_entry "features" "${COMMIT_SUBJECT#perf: }" ;;
            fix:*)       add_entry "fixes"    "${COMMIT_SUBJECT#fix: }" ;;
            docs:*)      add_entry "docs"     "${COMMIT_SUBJECT#docs: }" ;;
            style:*)     add_entry "style"    "${COMMIT_SUBJECT#style: }" ;;
            refactor:*)  add_entry "refactor" "${COMMIT_SUBJECT#refactor: }" ;;
            build:*)     add_entry "build"    "${COMMIT_SUBJECT#build: }" ;;
            ci:*)        add_entry "ci"       "${COMMIT_SUBJECT#ci: }" ;;
            chore:*)     add_entry "chore"    "${COMMIT_SUBJECT#chore: }" ;;
            *)           echo "Prefix not tracked. Skipping." ;;
          esac

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add "$FILE"

          if ! git diff --cached --quiet; then
            git commit -m "docs: update release notes v${LAST_RELEASE}"
            git push
          else
            echo "No changes to commit"
          fi
