name: Auto Release Notes

on:
  push:
    branches:
      - master

jobs:
  update-release-notes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update release notes
        run: |
          set -e

          COMMIT_MSG=$(git log -1 --pretty=%B)
          COMMIT_SUBJECT=$(git log -1 --pretty=%s)

          # Find latest release version
          LAST_RELEASE=$(git log --grep="^release:" --format="%s" -n 1 | sed 's/release:[[:space:]]*//')

          if [ -z "$LAST_RELEASE" ]; then
            echo "No release found. Skipping."
            exit 0
          fi

          mkdir -p release-notes
          FILE="release-notes/RELEASE_v${LAST_RELEASE}.txt"

          # Create file if it doesn't exist
          if [ ! -f "$FILE" ]; then
            {
              echo "Release v${LAST_RELEASE}"
              echo "Date: $(TZ=Asia/Kolkata date)"
              echo
              echo "Features:"
              echo
              echo "Fixes:"
            } > "$FILE"
          fi

          # Ignore release commits
          if echo "$COMMIT_SUBJECT" | grep -q "^release:"; then
            echo "Release commit detected. No append needed."
            exit 0
          fi

          # Append feat
          if echo "$COMMIT_SUBJECT" | grep -q "^feat:"; then
            sed -i "/^Features:/a\\- ${COMMIT_SUBJECT#feat: }" "$FILE"
          fi

          # Append fix
          if echo "$COMMIT_SUBJECT" | grep -q "^fix:"; then
            sed -i "/^Fixes:/a\\- ${COMMIT_SUBJECT#fix: }" "$FILE"
          fi

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add "$FILE"

          # Commit only if file changed
          if ! git diff --cached --quiet; then
            git commit -m "docs: update release notes v${LAST_RELEASE}"
            git push
          else
            echo "No changes to commit"
          fi
